import{k as e,$ as s,r as a,c as l,N as t,L as i,Q as r,K as o,U as u,P as n,a7 as d,Y as c,F as p,R as m,M as v,j as f,V as y,o as h,a6 as _}from"./vue-vendors-B4XdlKKZ.js";import{b,_ as g,s as x}from"./Layout.vue_vue_type_script_setup_true_lang-Bd80f82b.js";import{_ as k}from"./Content.vue_vue_type_script_setup_true_lang-CEfikmAR.js";import{_ as w}from"./Back.vue_vue_type_script_setup_true_lang-CZlTXmSD.js";import{V as P,W as C}from"./index-DZdj2b_n.js";import{F as j}from"./icons-C1_zt0kT.js";import{_ as z,$,a1 as G,a2 as A,D as T,a4 as S,a0 as D,o as H,B as O,a5 as M,V,S as E,U,r as F,m as B,I,T as N,y as q,A as K,t as L,K as R,v as Q}from"./naive-ui-DFBPfLe9.js";import"./photo-components-DTzq5atJ.js";import"./utils-DGAJShNI.js";const W={class:"flex gap-2 items-center"},Y={class:"flex gap-1"},J={key:0,class:"text-sm text-gray-500 mb-3"},X={class:"flex items-center justify-between"},Z=["onClick"],ee={class:"flex items-center justify-between"},se=["onClick"],ae={key:0,class:"mt-4 px-2"},le={class:"space-y-2"},te={class:"font-medium"},ie={class:"text-sm text-gray-500 mt-1"},re=b(e({__name:"PermissionCard",props:{title:{},description:{},permissions:{},selectedPermissions:{},subGroups:{}},emits:["update:selectedPermissions"],setup(e,{emit:h}){const{t:_}=s(),b=e,g=h;a(!0);const x=a(!1),k=l((()=>b.permissions.every((e=>b.selectedPermissions.includes(e.value))))),w=l((()=>b.permissions.some((e=>b.selectedPermissions.includes(e.value)))&&!k.value)),P=l((()=>b.permissions.filter((e=>b.selectedPermissions.includes(e.value))).length)),C=e=>{const s=[...b.selectedPermissions],a=s.indexOf(e);-1===a?s.push(e):s.splice(a,1),g("update:selectedPermissions",s)},j=()=>{const e=[...b.selectedPermissions];b.permissions.forEach((s=>{e.includes(s.value)||e.push(s.value)})),g("update:selectedPermissions",e)},B=()=>{const e=b.permissions.map((e=>e.value)),s=b.selectedPermissions.filter((s=>!e.includes(s)));g("update:selectedPermissions",s)},I=()=>{x.value=!x.value},N=e=>{if(!b.subGroups||!b.subGroups[e])return!1;return b.subGroups[e].permissions.map((e=>e.value)).every((e=>b.selectedPermissions.includes(e)))},q=e=>{if(!b.subGroups||!b.subGroups[e])return!1;return b.subGroups[e].permissions.map((e=>e.value)).some((e=>b.selectedPermissions.includes(e)))&&!N(e)};return(e,s)=>(i(),t(c(F),{title:e.title,class:"permission-card mb-4",size:"small",bordered:!0,segmented:{content:!0,footer:"soft"}},{"header-extra":r((()=>[v("div",W,[n(c(U),{value:P.value,max:99,"show-zero":!1,offset:[2,2]},{default:r((()=>[n(c(E),{type:k.value?"success":w.value?"warning":"default",size:"small",bordered:!1},{default:r((()=>[f(d(k.value?c(_)("All Selected"):w.value?c(_)("Partially Selected"):c(_)("None Selected")),1)])),_:1},8,["type"])])),_:1},8,["value"]),v("div",Y,[n(c(O),{size:"tiny",onClick:j,type:"primary",secondary:""},{default:r((()=>[f(d(c(_)("Select All")),1)])),_:1}),n(c(O),{size:"tiny",onClick:B,secondary:""},{default:r((()=>[f(d(c(_)("Cancel")),1)])),_:1}),n(c(O),{size:"tiny",onClick:I,tertiary:""},{default:r((()=>[f(d(x.value?c(_)("Hide Details"):c(_)("Show Details")),1)])),_:1})])])])),default:r((()=>[e.description?(i(),o("div",J,d(e.description),1)):u("",!0),e.subGroups&&Object.keys(e.subGroups).length>0?(i(),t(c(z),{key:1,class:"mb-2"},{default:r((()=>[(i(!0),o(p,null,m(e.subGroups,((a,l)=>(i(),t(c($),{key:l,title:a.name},{"header-extra":r((()=>[v("div",{class:"flex gap-1 mr-2",onClick:s[0]||(s[0]=y((()=>{}),["stop"]))},[n(c(O),{size:"tiny",onClick:e=>(e=>{if(!b.subGroups||!b.subGroups[e])return;const s=[...b.selectedPermissions];b.subGroups[e].permissions.forEach((e=>{s.includes(e.value)||s.push(e.value)})),g("update:selectedPermissions",s)})(l),type:"primary",secondary:"",disabled:N(l)},{default:r((()=>[f(d(c(_)("Select All")),1)])),_:2},1032,["onClick","disabled"]),n(c(O),{size:"tiny",onClick:e=>(e=>{if(!b.subGroups||!b.subGroups[e])return;const s=b.subGroups[e].permissions.map((e=>e.value)),a=b.selectedPermissions.filter((e=>!s.includes(e)));g("update:selectedPermissions",a)})(l),secondary:"",disabled:!q(l)&&!N(l)},{default:r((()=>[f(d(c(_)("Cancel")),1)])),_:2},1032,["onClick","disabled"])])])),default:r((()=>[n(c(G),{hoverable:""},{default:r((()=>[(i(!0),o(p,null,m(a.permissions,(a=>(i(),t(c(A),{key:a.value},{default:r((()=>[v("div",X,[v("div",{class:"flex items-center gap-2 flex-1 cursor-pointer",onClick:e=>C(a.value)},[n(c(T),{checked:e.selectedPermissions.includes(a.value)},null,8,["checked"]),n(c(S),{type:e.selectedPermissions.includes(a.value)?"primary":void 0},{default:r((()=>[f(d(a.label),1)])),_:2},1032,["type"])],8,Z),a.detail?(i(),t(c(D),{key:0,trigger:"hover",placement:"top"},{trigger:r((()=>[n(c(H),{class:"cursor-help text-gray-400 hover:text-primary"},{default:r((()=>s[1]||(s[1]=[v("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",width:"1em",height:"1em"},[v("path",{fill:"currentColor",d:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"})],-1)]))),_:1,__:[1]})])),default:r((()=>[f(" "+d(a.detail),1)])),_:2},1024)):u("",!0)])])),_:2},1024)))),128))])),_:2},1024)])),_:2},1032,["title"])))),128))])),_:1})):(i(),t(c(G),{key:2,hoverable:""},{default:r((()=>[(i(!0),o(p,null,m(e.permissions,(a=>(i(),t(c(A),{key:a.value},{default:r((()=>[v("div",ee,[v("div",{class:"flex items-center gap-2 flex-1 cursor-pointer",onClick:e=>C(a.value)},[n(c(T),{checked:e.selectedPermissions.includes(a.value)},null,8,["checked"]),n(c(S),{type:e.selectedPermissions.includes(a.value)?"primary":void 0},{default:r((()=>[f(d(a.label),1)])),_:2},1032,["type"])],8,se),a.detail?(i(),t(c(D),{key:0,trigger:"hover",placement:"top"},{trigger:r((()=>[n(c(H),{class:"cursor-help text-gray-400 hover:text-primary"},{default:r((()=>s[2]||(s[2]=[v("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",width:"1em",height:"1em"},[v("path",{fill:"currentColor",d:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"})],-1)]))),_:1,__:[2]})])),default:r((()=>[f(" "+d(a.detail),1)])),_:2},1024)):u("",!0)])])),_:2},1024)))),128))])),_:1})),n(c(M),null,{default:r((()=>[x.value?(i(),o("div",ae,[n(c(V),null,{default:r((()=>[f(d(c(_)("Permission Details")),1)])),_:1}),v("div",le,[(i(!0),o(p,null,m(e.permissions,(e=>(i(),o("div",{key:`detail-${e.value}`,class:"p-2 rounded hover:bg-gray-50"},[v("div",te,[f(d(e.label)+" ",1),n(c(E),{size:"small"},{default:r((()=>[f(d(e.value),1)])),_:2},1024)]),v("div",ie,d(e.detail),1)])))),128))])])):u("",!0)])),_:1})])),_:1},8,["title"]))}}),[["__scopeId","data-v-fd9fae23"]]),oe={class:"space-x-2"},ue={class:"flex flex-col gap-4"},ne={class:"flex justify-between items-center mb-2 flex-wrap gap-2"},de={class:"flex gap-2"},ce={class:"flex flex-col space-y-4"},pe={class:"flex justify-between space-x-2"},me=b(e({__name:"CreateView",setup(e){const l=B(),t=_(),{t:u}=s(),b=a(!1),z=a({abilities:[]}),$=a(null),G=a(!1),A=a(""),T=a([]),D=a({}),H=a({}),M=a({}),V={name:{type:"string",required:!0,trigger:["blur","input"],message:u("Please enter the token name")},expires_at:{type:"string",required:!1,trigger:["blur","input"],message:u("Please select the token expiration time")}},E=()=>{z.value.abilities=T.value.map((e=>e.value))},U=()=>{z.value.abilities=[]},W=e=>M.value&&M.value[e]&&Object.keys(M.value[e]).length>0,Y=e=>{var s;return(null==(s=M.value)?void 0:s[e])||{}},J=e=>({user:"用户资料、令牌、角色组和容量等用户相关权限",content:"相册、照片、分享和图片上传等内容管理权限",service:"工单和订单等服务相关权限",integration:"OAuth绑定和内容探索等集成功能权限",basic:"基础功能权限，所有令牌默认拥有",oauth:"OAuth第三方账号绑定相关权限",explore:"内容探索和浏览相关权限",upload:"图片上传相关权限"}[e]||""),X=async e=>{var s;e.preventDefault(),null==(s=$.value)||s.validate((async e=>{var s,a,t,i,r;if(!e){b.value=!0;try{const e=Array.isArray(z.value.abilities)&&z.value.abilities.length>0?[...z.value.abilities]:["*"],i={name:z.value.name,abilities:e};z.value.expires_at&&(i.expires_at=z.value.expires_at);const r=new FormData;r.append("name",i.name),i.expires_at&&r.append("expires_at",i.expires_at);for(const s of i.abilities)r.append("abilities[]",s);const o=await C({body:r});if("error"===(null==(s=o.data)?void 0:s.status))return l.error(null==(a=o.data)?void 0:a.message);A.value=(null==(t=o.data)?void 0:t.data.token)||"",G.value=!0}catch(o){l.error((null==(r=null==(i=o.response)?void 0:i.data)?void 0:r.message)||u("Failed to create token"))}finally{b.value=!1}}}))},Z=()=>{G.value=!1,t.push("/user/tokens")},ee=()=>{x.copyText(A.value).then((()=>{l.success(u("Copy successful")),setTimeout((()=>{t.push("/user/tokens")}),500)})).catch((()=>{l.error(u("Copy failed"))}))};return h((()=>{(async()=>{var e,s,a,t,i;try{const l=await P();if("success"===(null==(e=l.data)?void 0:e.status)){const e=(null==(a=null==(s=l.data)?void 0:s.data)?void 0:a.permissions)||[],r=(null==(i=null==(t=l.data)?void 0:t.data)?void 0:i.groups)||{};T.value=e,H.value=r;const o={};e.forEach((e=>{const s=e.category||e.value.split(":")[0];o[s]||(o[s]=[]),o[s].push(e)})),D.value=o;const u={};Object.entries(r).forEach((([s,a])=>{u[s]={},Object.entries(a).forEach((([a,l])=>{const t=l.map((s=>e.find((e=>e.value===s)))).filter((e=>void 0!==e));t.length>0&&(u[s][a]={name:a,permissions:t})}))})),M.value=u}}catch(r){l.error(u("Failed to get permissions"))}})()})),(e,s)=>(i(),o(p,null,[n(g,{"header-title":e.$t("Create Token"),"toggle-header":!1,"show-footer":!1},{default:r((()=>[n(k,{class:"mx-auto p-4 md:p-10 space-y-10 overflow-hidden"},{default:r((()=>[n(c(N),{vertical:""},{default:r((()=>[v("div",oe,[n(w,{to:"/user/tokens"})]),n(c(F),null,{default:r((()=>[n(c(q),{ref_key:"formRef",ref:$,"label-placement":"left","label-width":200,"label-align":"left",model:z.value,rules:V,onSubmit:y(X,["prevent"]),class:"form-container"},{default:r((()=>[n(c(K),{label:e.$t("Token Name"),path:"name"},{default:r((()=>[n(c(L),{value:z.value.name,"onUpdate:value":s[0]||(s[0]=e=>z.value.name=e),maxlength:20,placeholder:e.$t("Please enter the token name")},null,8,["value","placeholder"])])),_:1},8,["label"]),n(c(K),{label:e.$t("Token Expires Time"),path:"expires_at"},{default:r((()=>[n(c(R),{"formatted-value":z.value.expires_at,"onUpdate:formattedValue":s[1]||(s[1]=e=>z.value.expires_at=e),type:"datetime",class:"w-full","is-date-disabled":e=>e<Date.now(),"value-format":"yyyy-MM-dd HH:mm:ss",clearable:"",placeholder:e.$t("Please select the token expiration time")},null,8,["formatted-value","is-date-disabled","placeholder"])])),_:1},8,["label"]),n(c(K),{label:e.$t("Token Permissions"),path:"abilities"},{default:r((()=>[v("div",ue,[n(c(Q),{type:"info","show-icon":""},{default:r((()=>[f(d(e.$t("The token created without choosing any permissions will have full access rights. Please select the permissions carefully based on your needs.")),1)])),_:1}),v("div",ne,[n(c(S),null,{default:r((()=>[f(d(e.$t("Permissions")),1)])),_:1}),v("div",de,[n(c(O),{size:"small",onClick:E},{default:r((()=>[f(d(e.$t("Select All")),1)])),_:1}),n(c(O),{size:"small",onClick:U},{default:r((()=>[f(d(e.$t("Deselect All")),1)])),_:1})])]),n(c(N),{vertical:""},{default:r((()=>[(i(!0),o(p,null,m(D.value,((e,a)=>{return i(),o("div",{key:a},[n(re,{title:(l=a,{user:"用户管理",content:"内容管理",service:"服务管理",integration:"集成功能",basic:"基础功能",oauth:"OAuth认证",explore:"探索功能",upload:"上传功能"}[l]||l),description:J(a),permissions:e,"selected-permissions":z.value.abilities,"sub-groups":W(a)?Y(a):void 0,"onUpdate:selectedPermissions":s[2]||(s[2]=e=>z.value.abilities=e)},null,8,["title","description","permissions","selected-permissions","sub-groups"])]);var l})),128)),n(c(Q),{type:"info",class:"mt-4"},{default:r((()=>[f(d(e.$t("Permission Principle")),1)])),_:1})])),_:1})])])),_:1},8,["label"]),n(c(K),{class:"flex justify-end"},{default:r((()=>[n(c(O),{"attr-type":"submit",type:"primary",loading:b.value},{default:r((()=>[f(d(e.$t("Confirm Creation")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["model"])])),_:1})])),_:1})])),_:1})])),_:1},8,["header-title"]),n(c(I),{show:G.value,"onUpdate:show":s[3]||(s[3]=e=>G.value=e),preset:"card",title:e.$t("Created successfully"),size:"small",bordered:!1,class:"max-w-screen-sm mx-4 md:mx-auto max-h-[90vh] overflow-auto"},{action:r((()=>[v("div",pe,[n(c(O),{tertiary:"",onClick:Z},{default:r((()=>[f(d(e.$t("Close")),1)])),_:1}),n(c(O),{tertiary:"",type:"primary",class:"shrink-0",onClick:ee},{icon:r((()=>[n(c(j),{icon:"fa-solid fa-copy"})])),_:1})])])),default:r((()=>[v("div",ce,[n(c(Q),{type:"warning","show-icon":""},{default:r((()=>[f(d(e.$t("Please keep it safe. This Token will no longer be displayed after the window is closed.")),1)])),_:1}),n(c(L),{class:"select-all",value:A.value,readonly:""},null,8,["value"])])])),_:1},8,["show","title"])],64))}}),[["__scopeId","data-v-457aaef6"]]);export{me as default};
